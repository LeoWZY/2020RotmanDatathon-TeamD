---
title: "Datathon_Shirley"
author: "Shirley Gui"
date: "5/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#exploratory analysis
```{r}
data <- read.csv("/Users/Fragrans/Desktop/MMA_Datathon/data.csv")

#install.packages("dplyr")
library(dplyr)
library(stringr)
library(ggplot2)


unique(data$team_name)
unique(data$game_date)

#game1: 4/6/2019
game1 <- filter(data,game_date=='4/6/2019')
head(game1)
dim(game1)
unique(game1$team_name) #10 different teams

game1 %>% group_by(team_name) %>% summarise(n_player=n_distinct(player_name)) %>% arrange(desc(n_player)) #number of players in each team


#filter out canadian team
canada <- data[str_detect(data$team_name,'Canada'),]
canada_woman <- canada[str_detect(canada$team_name,'Women'),]
canada_man <- canada[str_detect(canada$team_name,'Men'),]

canada_woman %>% group_by(event_successful) %>% summarise(n_woman=n()) %>% mutate(rate=n_woman/sum(n_woman))
canada_man %>% group_by(event_successful) %>% summarise(n_man=n()) %>% mutate(rate=n_man/sum(n_man))
#The successful rate of woman is 0.68, and man is 0.71. Overall men perform slightly better than women.
canada_woman %>% group_by(period,event_successful) %>% summarise(n_woman=n()) %>% mutate(rate=n_woman/sum(n_woman))
canada_man %>% group_by(period,event_successful) %>% summarise(n_man=n()) %>% mutate(rate=n_man/sum(n_man))
#the successful rate for both man and woman is the best at period 4

#for event "play"
summary(canada_woman$event_type)
canada_woman %>% group_by(event_type,event_successful) %>% summarise(n_woman=n()) %>% mutate(rate=n_woman/sum(n_woman))
canada_man %>% group_by(event_type,event_successful) %>% summarise(n_man=n()) %>% mutate(rate=n_man/sum(n_man))
##event "shot" is especially low at 0.039(woman) and 0.053(man)

canada_shot <- filter(canada, event_type=='Shot')
canada_shot %>% group_by(shot_type) %>% summarise(n=n())  %>% arrange(desc(n))
canada_shot %>% group_by(shot_type,event_successful) %>% summarise(n=n()) %>% mutate(rate=n/sum(n)) %>% arrange(desc(rate))

#shot successful rate for each canadian player
canada_shot %>% group_by(player_name,event_successful)  %>% summarise(n=n()) %>% mutate(rate=n/sum(n)) %>% arrange(desc(rate)) %>% filter(event_successful=="t")



```

```{r}
#compare the performance of Canadian team with all other teams

#(Women) - Olympic Athletes from Russia
woman_russia <- data[str_detect(data$team_name,'Russia'),]
#(Women) - United States
woman_US <- data[str_detect(data$team_name,'United States'),]
#(Women) - Finland
woman_finland <- data[str_detect(data$team_name,'(Women) - Finland'),]
#(Men) - Switzerland
man_swzl <- data[str_detect(data$team_name,'Switzerland'),]
#(Men) - Czech Republic
man_CR <- data[str_detect(data$team_name,'Czech Republic'),]
#(Men) - South Korea
man_korea <- data[str_detect(data$team_name,'South Korea'),]
#(Men) - Finland
man_finland <- data[str_detect(data$team_name,'(Men) - Finland'),]
#(Men) - Germany
man_germany <- data[str_detect(data$team_name,'(Men) - Germany'),]


rank_success <- data %>% group_by(team_name,event_successful) %>% summarise(n=n()) %>% mutate(rate=n/sum(n)) %>% arrange(desc(rate))
rank_success <- rank_success %>% filter(event_successful=='t')
rank_success$rate = round(rank_success$rate,digits = 3)
rank_success

woman_rank <- rank_success[str_detect(rank_success$team_name,'Women'),]
man_rank <- rank_success[str_detect(rank_success$team_name,'Men'),]


#plot of men teams
area.color=c("coral2","skyblue3", "skyblue3", "skyblue3", "skyblue3","skyblue3")

p1 <- ggplot(data=man_rank, aes(x=rate, y=team_name)) +
  coord_cartesian(xlim = c(0.6, 0.75))+
  geom_bar(stat="identity", width=0.5, fill = area.color)+
  geom_text(aes(label = rate, y = team_name), size = 3.5, col="gray30",hjust=-0.2)+
  theme_minimal()

p1+labs(title = "Event Succuessful Rate of Men Teams",
              x = "Event Successful Rate", y = "Team Names")

#plot of woman teams
area.color2=c("skyblue3","skyblue3", "coral2", "skyblue3")

p2 <- ggplot(data=woman_rank, aes(x=rate, y=team_name)) +
  coord_cartesian(xlim = c(0.53, 0.72))+
  geom_bar(stat="identity", width=0.5, fill = area.color2)+
  geom_text(aes(label = rate, y = team_name), size = 4, col="gray30",hjust=-0.2)+
  theme_minimal()

p2+labs(title = "Event Succuessful Rate of Women Teams",
              x = "Event Successful Rate", y = "Team Names")


```
- Overall the Canadian Men Team is of best performance among all other men teams. However, the advantage of Canadian Women Team is less dominant, as it ranks the third out of four teams. The Russian Women Team is apparently left behind among all other teams with a successful rate of 0.58



```{r}
#total scores
scores <- data %>% filter(event_type=="Shot",event_successful=="t") %>% group_by(game_name,team_name) %>% count() %>% arrange(desc(game_name))
scores
#data %>% filter(period==4,event_successful=="t") %>% group_by(event_type) %>% count() ##no shots in period 4

unique(data[,"game_name"]) # 17 different games with only 28 observations


index <- scores$game_name %in% c("2019-02-17 - Olympic (Women) - Canada at Olympic (Women) - United States","2019-02-12 - Olympic (Women) - United States at Olympic (Women) - Canada","2018-02-21 - FInland at Canada	Olympic (Men) - Canada","2018-02-19 - Canada - Women at Olympic Athletes from Russia - Women","2018-02-18 - South Korea at Canada","2018-02-11 - Olympic Athletes from Russia - Women at Canada - Women","2018-02-21 - FInland at Canada")
competing_teams <- scores[!index,]
competing_teams

competing_teams_woman <- competing_teams[str_detect(competing_teams$team_name,'Women'),]
competing_teams_man <- competing_teams[str_detect(competing_teams$team_name,'Men'),]


#plot of woman teams
axis_label1 <- c("18/02/13","18/02/14","18/02/21","19/02/14","19/04/06","19/04/13","19/04/14")
p3 <- ggplot(data=competing_teams_woman, aes(x=game_name, y=n, fill = team_name)) +
  coord_cartesian(ylim = c(0,4))+
  geom_bar(stat="identity", width=0.5,position=position_dodge())+
  scale_fill_manual(values=c('coral2','skyblue',"darkseagreen"))+
  theme_minimal()

p3+labs(title = "Comparison of Scores for Woman Games",
              x = "Different Games", y = "Scores")+
  scale_x_discrete(labels=axis_label1)+
  theme(
     axis.text.x=element_text(),
    axis.ticks.x=element_blank())

#plot of man teams
axis_label2 <- c("2018-02-15","2018-02-16","2018-02-23","2018-02-24")
p4 <- ggplot(data=competing_teams_man, aes(x=game_name, y=n, fill = team_name)) +
  coord_cartesian(ylim = c(0,7))+
  geom_bar(stat="identity", width=0.5,position=position_dodge())+
  scale_fill_manual(values=c('coral2','skyblue',"darkseagreen","rosybrown1"))+
  theme_minimal()

p4+labs(title = "Comparison of Scores for Man Games",
              x = "Different Games", y = "Scores")+
  scale_x_discrete(labels=axis_label2)+
  theme(
    axis.text.x=element_text(),
    axis.ticks.x=element_blank())


```
- Lack data:
  "2019-02-17 - Olympic (Women) - Canada at Olympic (Women) - United States":	Olympic (Women) - United States
  "2019-02-12 - Olympic (Women) - United States at Olympic (Women) - Canada":	Olympic (Women) - Canada
  "2018-02-21 - FInland at Canada	Olympic (Men) - Canada": Olympic (Men) - Finland
  "2018-02-19 - Canada - Women at Olympic Athletes from Russia - Women":	Olympic (Women) - Russia
  "2018-02-18 - South Korea at Canada":	Olympic (Men) - South Korea
  "2018-02-11 - Olympic Athletes from Russia - Women at Canada - Women":	Olympic (Women) - Russia
  
- Insights:
1. From 18/02/14 to 19/04/06, the overall performance of U.S Women team has gradually increased.
2. There was a significant improvement for Finland Women team for 18/02/13 and 19/04/13.



```{r}
data %>% group_by(event_type) %>% summarise(n=n())
```



#shot
```{r}
library(caTools)
library(rpart.plot)
#shot data

shot <- filter(data, event_type=="Shot")
shot <- shot[,c("game_name","period","team_name","player_name","shot_type","situation_type","x_event","y_event","event_successful")]
shot <- shot %>% rename(x=x_event,y=y_event, goal=event_successful,shooter=player_name)
shot['goal'] <- data.frame(lapply(shot['goal'], as.character), stringsAsFactors=FALSE)

#convert "f/t" to binary 0/1
for (i in 1:nrow(shot)){
  if (shot['goal'][i,]=="f"){
    shot['goal'][i,] = 0 
  }
  else {
    shot['goal'][i,] = 1 
  }
}

#top players who have the most successful shots 
shooter <- shot %>% group_by(shooter,goal) %>% summarise(n=n())
shooter %>% filter(goal==1) %>% arrange(desc(n))

#add new variables "shot_dist" "shot_angel"
net <- c(200,85/2)
for (i in 1:nrow(shot)){
  shot$shot_dist[i] <- sqrt((net[1]-shot[i,"x"])^2+(net[2]-shot[i,"y"])^2)
}

#note: r always works wirh radians, not angel; radian=angel*pi/180
#example:tan(45*pi/180); atan(tan(45*pi/180)) /pi*180
for (i in 1:nrow(shot)){
  shot$shot_angel[i] <- atan((abs(net[2]-shot[i,"y"]))/abs(net[1]-shot[i,"x"]))/pi*180
}


shot$goal = factor(shot$goal)
shot$period = factor(shot$period)

set.seed(100)
split.1 <- sample.split(shot$goal, 0.7)
shot_train <- subset(shot, split.1==TRUE)
shot_test <- subset(shot, split.1==FALSE)


#Logistic model
model1 <- glm(goal ~ shot_dist + shot_angel + shot_type , data=shot_train, family = binomial(link="logit"))
summary(model1)
prob <- predict(model1, type="response")
results.1 <- ifelse(prob>0.5,1,0)
#accuracy rate:
1-(mean(results.1!=shot_test$goal))  #0.9648774


#decision tree model
library(rpart)
tree <- rpart(goal ~ shot_dist + shot_angel , data=shot, control=rpart.control(cp=.005))
plot(tree, uniform=TRUE, margin=.05)
text(tree)
rpart.plot(tree)

pred_tree <- predict(tree, newdata = shot_test)
results.2 <- ifelse(pred_tree[,"0"]>0.5,0,1)
#accuracy rate:
1-(mean(results.2!=shot_test$goal)) #0.9659443

tree


```
- Based on the models, shot distance and shot angel are significant in determining whether the shot is successful.
- Our next step is to use Canadian Woman data to predict the prob of successful shot based on each player's average distance and angel data.

```{r}
#Use logistic model to select top 5 shooters
#Method: average all probablities of succussful shot for each player
cw_df <- filter(shot, team_name=="Olympic (Women) - Canada")
md <- glm(goal ~ shot_dist + shot_angel , data=shot_train, family = binomial(link="logit"))
cw_df$prob_goal <- predict(md, newdata = cw_df, type="response")
shooters <- cw_df %>% group_by(shooter) %>% summarise(prob=mean(prob_goal)) %>% arrange(desc(prob))
shooters


top_shot_names <- c("Haley Irwin","Melodie Daoust","Lauriane Rougeau","Natalie Spooner","Ann-Sophie Bettez")
top_shooters <- filter(cw_df, shooter %in% top_shot_names)[,c("shooter","prob_goal")] %>% arrange(shooter)
library(ggplot2)
p2 <- ggplot(top_shooters, aes(x=shooter, y=prob_goal, fill=shooter))   +geom_boxplot(varwidth = TRUE, alpha=0.2) +
    theme(legend.position="none") 

p2 + labs(x="shooters", y = "predicted successful rate")
```
- Top 5 shooters:
Haley Irwin	0.109572307			
Melodie Daoust	0.085702620			
Lauriane Rougeau	0.065863791			
Natalie Spooner	0.064987426			
Ann-Sophie Bettez	0.055127040	



#play
```{r}

#play data (reflect the quality of passes)
pass <- data %>% filter(event_type=='Play')
pass <- pass[,c("game_name","period","team_name","player_name","receiver_name","situation_type","x_event","y_event","receiver_x","receiver_y","event_successful")]
pass <- pass %>% rename(x=x_event,y=y_event, goal=event_successful)
pass['goal'] <- data.frame(lapply(pass['goal'], as.character), stringsAsFactors=FALSE)

#convert "f/t" to binary 0/1
for (i in 1:nrow(pass)){
  if (pass['goal'][i,]=="f"){
    pass['goal'][i,] = 0 
  }
  else {
    pass['goal'][i,] = 1 
  }
}


#add new variables "shot_dist" "shot_angel"
for (i in 1:nrow(pass)){
  pass$distance[i] <- sqrt((pass[i,"receiver_x"]-pass[i,"x"])^2+(pass[i,"receiver_y"]-pass[i,"y"])^2)
}

#note: r always works wirh radians, not angel; radian=angel*pi/180
#example:tan(45*pi/180); atan(tan(45*pi/180)) /pi*180
for (i in 1:nrow(pass)){
  pass$angel[i] <- atan((abs(pass[i,"receiver_y"]-pass[i,"y"]))/abs(pass[i,"receiver_x"]-pass[i,"x"]))/pi*180
}

pass$goal = factor(pass$goal)
pass$period = factor(pass$period)

pass <- na.omit(pass)

set.seed(100)
split.1 <- sample.split(shot$goal, 0.7)
pass_train <- subset(pass, split.1==TRUE)
pass_test <- subset(pass, split.1==FALSE)

#1.logistic model

model2 <- glm(goal ~ distance + angel+x +y+receiver_x+receiver_y  , data=pass_train, family = binomial(link="logit"))
summary(model2)
prob2 <- predict(model2, newdata = pass_test, type="response")

results.3 <- ifelse(prob2>0.5,1,0)
#accuracy rate:
1-(mean(results.3!=pass_test$goal))  #0.7340191


#2.decision tree model
#install.packages("rpart.plot")
library(rpart.plot)
tree2 <- rpart(goal~distance + angel + x +y+receiver_x+receiver_y+period+team_name, data = pass_train, method = 'class')

plot(tree2, uniform=TRUE, margin=.05)
text(tree2)
rpart.plot(tree2)

pred_tree2 <- predict(tree2, newdata = pass_test)
results.4 <- ifelse(pred_tree2[,"0"]>0.5,0,1)
#accuracy rate:
1-(mean(results.4!=pass_test$goal))  #0.7526329

tree2

```

- Based on the logistic, significant variables that determines whether the pass is successful are: distance,angel,x,receiver_x.
- Our next step is to use Canadian Woman data to predict the prob of successful pass based on each player's significant variables.


```{r}
#Use logistic model to select top 5 possers
#Method: average all probablities of succussful pass for each player
cw_df2 <- filter(pass, team_name=="Olympic (Women) - Canada")
model2 <- glm(goal ~ distance + angel+x +y+receiver_x+receiver_y  , data=pass_train, family = binomial(link="logit"))
cw_df2$prob_goal <- predict(model2, newdata = cw_df2, type="response")
passers <- cw_df2 %>% group_by(player_name) %>% summarise(prob=mean(prob_goal)) %>% arrange(desc(prob))
passers

top_pass_names <- c("Shannon Szabados","Haley Irwin","Genevieve Lacasse","Ann-Renee Desbiens","Loren Gabel")
top_passers <- filter(cw_df2, player_name %in% top_pass_names)[,c("player_name","prob_goal")] %>% arrange(player_name)
library(ggplot2)
p1 <- ggplot(top_passers, aes(x=player_name, y=prob_goal, fill=player_name))   +geom_boxplot(varwidth = TRUE, alpha=0.2) +
    theme(legend.position="none")
p+labs(x="passers", y = "predicted successful rate")


```
- Top 5 passers: 

Shannon Szabados	0.7892871			
Haley Irwin	0.7862256			
Genevieve Lacasse	0.7837537			
Ann-Renee Desbiens	0.7803795			
Loren Gabel  0.7549695	

- We oberserved that Haley Irwin is dominant in both passers and shooters. So we want to analyze more specifically on Haley.


```{r}
Haley <- filter(canada_woman, player_name == "Haley Irwin")
Haley %>% group_by(event_type, event_successful) %>% summarise(n=n())
```

```{r}
canada_woman
```



#power play a>b
```{r}
canada_woman %>% group_by(situation_type) %>% summarise(n=n())
```

#penalty kill a<b
